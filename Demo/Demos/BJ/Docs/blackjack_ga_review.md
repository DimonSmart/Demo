# Обзор текущей реализации Blackjack и план интеграции генератора стратегии

## 1. Пользовательские страницы и сценарии
- **Страница `/bjgame`** использует Blazor-компоненты `GameInfo`, `PlayingHand`, `PlayerHands` и `BlackJackGameControls`, отображая состояние `BlackjackGameBase` и позволяя вручную запускать действия игрока. На инициализации создаётся `Shoe` на шесть колод, запускается `BlackjackGameWithPlayer`, состояние синхронизируется через событие `GameStateChanged`. Пользовательский интерфейс не предусматривает автоматическую игру и не отображает параметры правил (например, ограничения по двойному удвоению или сплиту).【F:Demo/Pages/BJGame.razor†L1-L113】
- **Страница `/tsm`** демонстрирует готовый шаблон для настройки генетического алгоритма: параметры читаются из формы, создаётся объект `Genetic<TChromosome>`, состояние хранится в компоненте, предусмотрены автоитерации. Этот подход можно переиспользовать для будущей страницы генерации стратегии Blackjack, заменив типы хромосом и набор параметров.【F:Demo/Pages/TSM.razor†L1-L166】

## 2. Архитектура и логика Blackjack
### 2.1 Основные сущности
- `BlackjackGameBase` управляет состоянием партии: хранит списки рук игрока и дилера, баланс, текущее состояние (`GameNotStarted/GameStarted/GameFinished`), константные значения ставки, штрафа за сдачу и лимита сплитов. Методы `Can*` проверяют доступность действий, а `StartNewRoundAsync`, `HitAsync`, `StandAsync`, `DoubleDownAsync`, `SplitAsync`, `SurrenderAsync` изменяют состояние и вызывают обработку дилера. Завершение рук делегируется `EndHandAsync`, а дилер добирает карты в `DealerPlayAsync` с последующей проверкой результатов.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L1-L309】
- `Hand`, `PlayerHand`, `DealerHand` отвечают за вычисление значения руки. `Hand` суммирует очки, учитывая корректировку тузов, а `PlayerHand` добавляет ставку и исход, поддерживает сплит. `DealerHand` добавляет возможность «переворачивать» карты. Эти типы предоставляют интерфейс `IHandValues` для работы со стратегией.【F:Demo/Demos/BJ/Hand.cs†L1-L56】【F:Demo/Demos/BJ/PlayerHand.cs†L1-L21】【F:Demo/Demos/BJ/DealerHand.cs†L1-L10】
- `StrategyTable` кодирует решения игрока: массив действий, покрывающий жёсткие суммы, мягкие суммы и пары. `GetAction` перенаправляет на методы `GetTotalAction` или `GetPairSplittingAction` в зависимости от того, является ли рука парой.【F:Demo/Demos/BJ/StrategyTable.cs†L1-L43】
- `BlackjackGameAuto` задумывалась как автоматический режим: при создании принимает стратегию и должна последовательно применять действия до завершения руки, затем инициировать новую раздачу внутри текущего шузе.【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L1-L62】

### 2.2 Соответствие правилам
- **Начало раунда:** `StartNewRoundAsync` списывает фиксированную ставку $10, создаёт по две карты игроку и дилеру (вторая карта дилера закрыта), мгновенно завершает партию при натурале игрока. Ограничения по минимальной/максимальной ставке, страховке, сайд-бетам отсутствуют.
- **Ход игрока:**
  - `HitAsync` выдаёт дополнительную карту, завершает руку при 21 или переборе.
  - `StandAsync` просто переводит ход к следующей руке или дилеру.
  - `DoubleDownAsync` удваивает ставку, добирает одну карту и вызывает `StandAsync` — логика соответствует классическому правилу удвоения «одна карта и стоп».
  - `SplitAsync` создаёт вторую руку и списывает дополнительную ставку, но не добирает стартовую карту ни в одну из рук, а значит игрок остаётся с одиночными картами до ручного «Hit». Правила ограничений по повторным сплитам, сплиту тузов и удвоению после сплита не настраиваются; `MaxSplits` фиксирован в три итерации, что даёт максимум четыре руки.
  - `SurrenderAsync` разрешена пока в руке две карты; ставка сокращается на половину, игра завершается.
- **Ход дилера:** дилер открывает вторую карту и тянет, пока значение < 17. Отдельные правила для «soft 17» или пикапа нескольких тузов не реализованы; дилер всегда стоит на 17, даже мягком.
- **Расчёт выигрыша:** для каждой руки вызывается `CheckWinConditions`. Баланс игрока заранее уменьшен на ставку; при победе баланс увеличивается на `Bet * 2`, что эквивалентно возврату ставки и выплате 1:1. Натурал не оплачивается коэффициентом 3:2, бонус не считается. `GamesPlayedInShoe` не увеличивается нигде, поэтому статистика раунда не ведётся.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L238-L303】

## 3. Обнаруженные проблемы и потенциальные ошибки
1. **Автоматический режим не работает.** В `PlayRoundAsync` условие цикла `while (CanTakeAction() && GameFinished)` содержит проверку `GameFinished`, из-за чего тело цикла никогда не выполнится: как только раунд стартовал, `GameFinished == false`. Предположительно должно быть `!GameFinished`.【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L21-L29】
2. **Неверная индексация сплитов тузов.** `StrategyTable.GetAction` при паре вычисляет `pairRank` как `hand.HandValue / 2`. Для пары тузов после корректировки значения руки (12) функция возвращает 6, что ведёт к чтению ячейки «пара шестёрок», а не «пара тузов». Нужно использовать исходный ранг карты (`hand.Cards[0].Rank`) или расширить `IHandValues` признаком ранга. Это критично для корректного применения любой сгенерированной таблицы.【F:Demo/Demos/BJ/StrategyTable.cs†L25-L37】【F:Demo/Demos/BJ/Hand.cs†L34-L51】
3. **Сплит не добирает стартовые карты.** После вызова `SplitAsync` обе руки содержат по одной карте; по правилам Blackjack каждая новая рука должна автоматически получить вторую карту из колоды (кроме исключений с тузами, где разрешается только одна карта). Это влияет на базовую стратегию и вычисление фитнес-функции: текущая реализация моделирует нетипичный вариант игры.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L198-L218】【F:Demo/Demos/BJ/PlayerHand.cs†L9-L19】
4. **Статистика и управление шузом не завершены.** Переменная `GamesPlayedInShoe` нигде не увеличивается, `ResetGameVariables` (используемый для авто-режима) создаёт новые руки, но не списывает ставки и не переводит состояние в `GameStarted`. Это потенциально приведёт к несогласованным данным при внедрении автоматического расчёта стратегии.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L22-L64】【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L12-L20】
5. **Недостающие правила:** нет поддержки страховки, сдачи после удвоения, ограничений «Double after Split», «Resplit Aces», «Dealer hits soft 17» и пр. Эти ограничения планируется задавать при генерации стратегии, поэтому стоит выделить структуру конфигурации правил, а не хранить их жёстко в коде.

## 4. Рекомендации по исправлению текущего кода
- Исправить условие в `BlackjackGameAuto.PlayRoundAsync` и привести `ResetGameVariables` к корректному состоянию (сбрасывать индекс руки, очищать список без сдачи карт, запускать новый раунд через существующий метод `StartNewRoundAsync`).
- Расширить `IHandValues`, чтобы стратегия могла определить ранги карт пары, или предоставить вспомогательный метод в `StrategyTable`, использующий непосредственно `PlayerHand`. Без этого расчёт сплитов тузов будет некорректным.
- После сплита автоматически выдавать дополнительную карту каждой руке. Для тузов можно предусмотреть отдельную опцию в будущем объекте правил.
- Инкрементировать `GamesPlayedInShoe` после завершения партии, а также фиксировать поднятие «red card» (момент замены шуза) в статистике.
- Добавить объект-конфигурацию `BlackjackRules` с флагами (разрешён ли сплит по конкретным парам, разрешено ли удвоение после сплита, сдача, лимит колод и т. п.) и использовать его в методах `Can*` и обработчиках действий вместо жёстких констант.

## 5. Интеграция нового генератора стратегии
1. **Сервис уровня домена.** Создать в общем проекте (например, `Demo.Services`) сервис `BlackjackStrategyGenerationService`, принимающий `BlackjackRules`, параметры ГА (размер популяции, вероятности, ограничения) и возвращающий `StrategyTable`. Сервис будет оборачивать вызов новой библиотеки и использовать игровые классы для симуляции раундов при расчёте фитнеса.
2. **Переработка проекта `BJTableCalculator`.** Текущие классы `BlackjackChromosome`, `BlackjackChromosomeFactory`, `BlackjackChromosomeMutator`, `BlackjackFitnessFunction` пустые или заглушки. Их следует переместить/реализовать в общем проекте, опираясь на новую библиотеку:
   - Хромосома должна инкапсулировать таблицу стратегий и уметь клонировать себя.
   - Мутатор — менять решения с учётом ограничений правил.
   - Фитнес — проводить серию симуляций с использованием `BlackjackGameAuto`, исправив её работу.
   - Фабрика — генерировать начальные стратегии, учитывая ограниченные действия (например, запрещённый сплит для конкретных пар).
3. **Новая страница.** На основе `/tsm` создать `/bj-strategy-generator`:
   - Форма ввода параметров правил (флажки «Разрешить сплит 10/10», «Разрешить удвоение после сплита», «Dealer hits soft 17» и т. д.), параметров ГА и ограничений по шузу.
   - Кнопка запуска, отображение текущего лучшего результата (например, таблица или JSON), возможность экспортировать стратегию в `StrategyTable` для игрового режима.
   - Повторное использование компонентов для вывода игровой статистики (можно добавить модальное окно с симуляцией лучшей стратегии).
4. **Интероперабельность.** Сгенерированную таблицу следует сохранять в формате, который можно передать в `BlackjackGameWithPlayer` (например, файл JSON или запись в базу), чтобы пользователь мог протестировать стратегию на существующей странице `/bjgame`.
5. **Покрытие тестами.** Добавить юнит-тесты в `GeneticAlgorithmTests` для проверки:
   - Корректности мэппинга стратегии на действия (особенно для пар тузов и мягких сумм).
   - Соблюдения правил, установленных в конфигурации, в ходе симуляции.
   - Работы автоматического режима и корректного завершения игры.

## 6. Следующие шаги
- Принять решения по списку поддерживаемых правил и описать их в `BlackjackRules`.
- Исправить найденные ошибки в логике, чтобы текущая игра соответствовала реальным правилам.
- Реализовать недостающие части ГА и интегрировать новую библиотеку через сервис.
- Создать новую страницу генерации стратегии, используя шаблон страницы `TSM` и обеспечив возможность применять результат на странице игры.
- После внедрения — провести профилирование, так как симуляция множества партий в ГА потребует оптимизаций (кеширование значений руки, уменьшение количества аллокаций при симуляции).
