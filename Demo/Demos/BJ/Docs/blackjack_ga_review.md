# Обзор текущей реализации Blackjack и автоигры

## 1. Автоматический режим

### 1.1 Цикл симуляции
- `BlackjackGameAuto.PlayGameAsync` крутится до тех пор, пока шуз не опустеет и пока не будет поднята «красная карта». Перед каждой партией вызывается `StartNewRoundAsync`, после чего раздача полностью проходит в `PlayRoundAsync`. Это гарантирует, что каждая симуляция стартует через единый путь базового класса и корректно списывает ставку игрока.【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L11-L36】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L147-L174】
- `PlayRoundAsync` повторяет выбор действия до тех пор, пока есть допустимые действия и игра не завершена. Значение открытой карты дилера считывается из первой карты, отмеченной `IsFaceUp`, что соответствует тому, как карты раздаются в `BlackjackGameBase` (первая открыта, вторая закрыта).【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L38-L48】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L52-L72】

### 1.2 Исполнение стратегии
- Решение берётся из `StrategyTable`, которая покрывает жёсткие суммы, мягкие суммы и пары. Для недоступных действий (`Double`, `Split`, `Surrender`) `ExecuteActionAsync` откатывается к `Hit`, чтобы симуляция продолжалась даже с «нелегальными» рекомендациями таблицы.【F:Demo/Demos/BJ/StrategyTable.cs†L23-L43】【F:Demo/Demos/BJ/BlackjackGameAuto.cs†L50-L84】
- При сплите каждая из рук получает дополнительную карту через `DealCardToHand`, а для тузов действует ограничение `CanHitAfterSplitAces` (в базовом классе руки помечаются завершёнными, если правило запрещает добор). Это важно учитывать при построении таблицы, потому что стратегия не сможет заставить автоигрока добрать карты поверх запрещённого правила.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L198-L227】

### 1.3 Ограничения и наблюдения
- Счётчик `GamesPlayedInShoe` по-прежнему не используется, поэтому статистика партий внутри шуза не ведётся. Это место можно задействовать, чтобы замерять фитнес при работе генетического алгоритма.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L21-L33】
- `ResetGameVariables` выдаёт новую руку и дилеру, и игроку, но оставляет состояние `GameNotStarted`. Сейчас метод не вызывается из автоигры и может привести к рассинхронизации, если использовать его напрямую вместо `StartNewRoundAsync` (ставка не спишется, события не отработают). Лучше продолжать стартовать раунды только через публичный метод базового класса.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L74-L104】
- Автоигрок останавливается лишь по условию шуза. Если нужно ограничить количество партий (например, ровно 10 000), придётся добавить внешний счётчик итераций или ранний выход из цикла.
- Фолбэк на `Hit` и отсутствие нормализации таблицы означает, что некорректная стратегия может систематически искажать статистику (например, стратегия, всегда выбирающая `Surrender` после трёх карт, всё равно будет бить). При оценке фитнеса стоит учитывать этот эффект.

## 2. Реализация правил Blackjack

### 2.1 Жёстко заданное поведение
- Базовая ставка фиксирована в 10 единиц, штраф за сдачу — половина ставки. Эти значения не вынесены в конфигурацию и применяются для каждой новой партии.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L16-L20】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L147-L175】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L234-L244】
- Раздача стартует двумя картами игроку и двумя картами дилеру (вторая дилера закрыта), натурал игрока мгновенно завершает раунд через `EndHandAsync`.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L46-L72】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L165-L174】
- Удвоение разрешено для любой руки из двух карт, в том числе после сплита. После `DoubleDownAsync` автоматически выполняется `Stand`. Настроек «Double after Split only» или запрета удвоения на мягких суммах нет.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L113-L143】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L176-L197】
- Сплит разрешён максимум три раза (до четырёх рук). Руки получают по дополнительной карте сразу в методе сплита. Для тузов можно запретить добор через опцию `CanHitAfterSplitAces`, однако респлит тузов не блокируется — ограничение по числу рук общее.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L18-L21】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L130-L208】
- Сдача разрешена только на первой двухкартовой руке и заканчивает раунд немедленно со штрафом в половину ставки. Это фактически «late surrender», но дилер не делает предварительный «peek», так что технически ближе к «surrender без проверки».【F:Demo/Demos/BJ/BlackjackGameBase.cs†L134-L144】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L218-L236】
- Дилер добирает до 17 и стоит на любой 17 (мягком тоже), страховка и сайд-беты отсутствуют. После завершения руки выплаты для победы — 1:1, для пуша — возврат ставки. Натурал не оплачивается 3:2, бонусы не поддерживаются.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L228-L303】

### 2.2 Уже доступная конфигурация
- `BlackjackRulesOptions` содержит единственный параметр `CanHitAfterSplitAces`, который управляет поведением после сплита тузов. Все остальные ограничения захардкожены в базовом классе.【F:Demo/Demos/BJ/BlackjackRulesOptions.cs†L1-L8】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L202-L208】

### 2.3 Что можно вынести в настройки без серьёзной перестройки
- **Поведение дилера на soft 17.** Достаточно добавить флаг и изменить условие цикла в `DealerPlayAsync` (`< 17` против `<= 17`, плюс проверка мягкости).【F:Demo/Demos/BJ/BlackjackGameBase.cs†L228-L248】
- **Число разрешённых сплитов и респлит тузов.** Сейчас лимит хранится в константе `MaxSplits`; его можно перенести в `BlackjackRulesOptions` и добавить отдельный флаг `AllowResplitAces`, который проверяется перед вызовом `SplitAsync`.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L16-L21】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L119-L144】
- **Условия удвоения.** Проверки в `CanDoubleDown` можно расширить (например, разрешать только на суммах 9–11 или запретить после сплита) по новым полям в настройках. Это затронет лишь один метод и не потребует изменений в остальной логике.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L113-L123】
- **Тип сдачи.** Флаг, отключающий `SurrenderAsync`, или выбор между «late» и «early», управляется дополнительным условием в `CanSurrender` и в `SurrenderAsync`. Для «early» потребуется проверка карты дилера до `DealerPlayAsync`, но изменения остаются локальными.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L130-L145】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L218-L236】
- **Размер ставки и коэффициенты выплат.** Значения `InitialBet`, `SurrenderPenalty` и логика `CheckWinConditions` можно привязать к настройкам. Это позволит моделировать игры с выплатой 3:2 за натурал или 6:5, а также альтернативные лимиты по ставкам.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L16-L20】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L250-L303】

### 2.4 Правила, требующие существенной доработки
- **Страховка и Even Money.** Потребуется новый поток действий до того, как игрок начнёт ходить, и переработка расчёта исходов.
- **Специальные ограничения на сплит (например, запрет сплита 10/10).** Нужна логика, анализирующая комбинации и обновляющая стратегическую таблицу, чтобы автоигрок не выбирал запрещённые переходы.
- **Бонусные ставки и побочные игры.** Они требуют отдельного механизма расчёта выплат и учёта баланса.
- **Правила peek/early surrender.** Нужно реализовать проверку натурала дилера до начала хода игрока, что затрагивает цепочку `StartNewRoundAsync → EndHandAsync → DealerPlayAsync`.

## 3. Рекомендации для интеграции с генетическим алгоритмом
- Перед использованием автоигрока в фитнес-функции стоит начать вести статистику (`GamesPlayedInShoe`, суммарный выигрыш/проигрыш за сессию) и возвращать агрегированную метрику вместо чтения баланса извне.【F:Demo/Demos/BJ/BlackjackGameBase.cs†L21-L33】【F:Demo/Demos/BJ/BlackjackGameBase.cs†L250-L303】
- Желательно нормализовать или валидировать таблицу перед симуляцией, чтобы удалять запрещённые действия и не полагаться на фолбэк `Hit`. Это повысит точность оценки стратегии.
- Разумно вынести в конфигурацию ключевые параметры правил (см. раздел 2.3) и передавать их при создании `BlackjackGameAuto`, чтобы генетический алгоритм работал в тех же условиях, что и целевая игра.
