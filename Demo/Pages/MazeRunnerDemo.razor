@page "/mazerunnerdemo"

@using Demo.Components
@using Demo.Demos.MazeRunner
@using Demo.Services
@using DimonSmart.MazeGenerator
@using Microsoft.SemanticKernel
@using Microsoft.SemanticKernel.ChatCompletion
@inject PageTitleService PageTitleService
@inject LogStore LogStore

@implements IMazePlotter

<link rel="stylesheet" href="css/demos.css" />
<PageTitle>Maze Generator Demo</PageTitle>

<div class="page-container" style="display: flex;">
    <!-- Left container: Maze, Joystick and Chat -->
    <section style="flex: 1; overflow-y: auto; padding: 20px;">
        @if (_maze != null)
        {
            <div style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; align-items: flex-start;">
                <!-- Maze display container -->
                <div style="flex: 1 1 300px;">
                    <div style="display: flex; justify-content: center;">
                        <CascadingValue Value="_maze.Robot">
                            <MazeDisplay TCell="MazeRunnerCellModel" Maze="_maze">
                                <CellTemplate Context="cell">
                                    <MazeRunnerCell X="@cell.X" Y="@cell.Y" Cell="@cell.Cell" />
                                </CellTemplate>
                            </MazeDisplay>
                        </CascadingValue>
                    </div>
                </div>

                <!-- Joystick control container -->
                <div style="flex: 0 0 auto;">
                    <Joystick Width="150px" Height="150px"
                              OnUpClicked="OnUpClicked"
                              OnDownClicked="OnDownClicked"
                              OnLeftClicked="OnLeftClicked"
                              OnRightClicked="OnRightClicked" />
                </div>
            </div>
        }
        <!-- Chat block -->
        <div style="margin-top: 20px; text-align: center; border: 1px solid #ccc; padding: 10px;">
            <input type="text" @bind="UserCommand" placeholder="Enter command (e.g., move right)" style="width:300px;" />
            <button @onclick="ProcessUserCommand">Send Command</button>
            <div style="margin-top:10px;">Assistant's response: @ResponseMessage</div>
        </div>
    </section>

    <!-- Right container: Log view (full height) -->
    <section style="min-width: 200px; width: 33%; border-left: 1px solid #ccc; height: 100%; overflow-y: auto;">
        <LogView LogMessages="@LogStore.Messages" />
    </section>
</div>

@code {
    protected int XSize = 9;
    protected int YSize = 9;
    protected MazeRunnerMaze? _maze;
    protected Kernel? _kernel;

    private string UserCommand { get; set; } = "";
    private string ResponseMessage { get; set; } = "";

    protected override void OnInitialized()
    {
        base.OnInitialized();
        PageTitleService.SetTitle("Maze runner");
        GenerateMazeAsync();
    }

    protected void GenerateMazeAsync()
    {
        _maze = new MazeRunnerMaze(XSize, YSize);
        var mazeBuilder = new MazeBuilder<MazeRunnerCellModel>(_maze);
        mazeBuilder.Build(this, CancellationToken.None);
        _kernel = KernelFactory.BuildKernel(_maze);

        StateHasChanged();
    }

    public async Task PlotWallAsync(int x, int y)
    {
        StateHasChanged();
        var delay = TimeSpan.FromMilliseconds(50);
        await Task.Delay(delay);
    }

    // Joystick event handlers with log updates
    private void OnUpClicked()
    {
        LogStore.Messages.Add($"Moved forward: {_maze?.Robot.MoveForward()}");
        StateHasChanged();
    }

    private void OnDownClicked()
    {
        LogStore.Messages.Add($"Moved down: {_maze?.Robot.MoveBackward()}");
        StateHasChanged();
    }

    private void OnLeftClicked()
    {
        LogStore.Messages.Add($"Moved left: {_maze?.Robot.MoveLeft()}");
        StateHasChanged();
    }

    private void OnRightClicked()
    {
        LogStore.Messages.Add($"Moved right: {_maze?.Robot.MoveRight()}");
        StateHasChanged();
    }

    private async Task ProcessUserCommand()
    {
        string systemPrompt = @"
You are a chatbot capable of controlling a robot in a maze.
The robot understands and can execute the following commands: move up, down, left, right.
The robot cannot pass through walls.
When issued the 'look around' command, the robot look around for 1 cell.

In the grid:
  '?' indicates an unexplored cell.
  '#' indicates a wall.
  '_' indicates an open passage.
  'R' indicates the robot's current position.
  Any discovered object (e.g., 'apple') is labeled with its letter 'A' for apple.
Once a cell is discovered, it remains visible permanently.
";

        var chatCompletionService = _kernel.GetRequiredService<IChatCompletionService>();

        ChatHistory chatHistory = [];
        chatHistory.AddSystemMessage(systemPrompt);
        chatHistory.AddUserMessage(UserCommand);
        var chatResult = await chatCompletionService
         .GetChatMessageContentAsync(chatHistory, new PromptExecutionSettings
             {
                 FunctionChoiceBehavior = FunctionChoiceBehavior.Auto()
             }, _kernel);
        ResponseMessage = chatResult.ToString();
        LogStore.Messages.Add($"Semantic: {ResponseMessage}");
        StateHasChanged();
    }
}
