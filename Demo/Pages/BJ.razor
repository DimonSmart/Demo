@page "/tsm"
@using Demo.Components
@using Demo.Demos.BJ
@using Demo.Demos.TSM
@using Demo.Demos.TSM.GeneralGenetic
<link rel="stylesheet" href="css/demos.css"/>

<PageTitle>Black jack</PageTitle>

<div class="page-container">

    <div class="parameters-container">
        <h3>Black jack</h3>

        <div class="settings-container">
            <div class="margin-right">
                <label>Population Size:</label>
                <input type="number" @bind="PopulationSize" min="@PopulationSizeMin" max="@PopulationSizeMax" title="The number of individuals in the population. Higher values may increase computation time but can lead to better solutions."/>
            </div>

            <div class="margin-right">
                <label>Best Chromosomes:</label>
                <input type="number" @bind="BestChromosomes" min="@BestChromosomesMin" max="@BestChromosomesMax" title="The number of top-performing chromosomes to retain for the next generation."/>
            </div>

            <div class="margin-right">
                <label>Crossover Chromosomes:</label>
                <input type="number" @bind="CrossoverChromosomes" min="@CrossoverChromosomesMin" max="@CrossoverChromosomesMax" title="The number of chromosomes to be created through crossover operations."/>
            </div>

            <div class="margin-right">
                <label>Mutation Chromosomes:</label>
                <input type="number" @bind="MutationChromosomes" min="@MutationChromosomesMin" max="@MutationChromosomesMax" title="The number of chromosomes to be mutated in each generation."/>
            </div>
        </div>
        @if (Genetic == null)
        {
            <button @onclick="InitializeGenetic">Run Algorithm</button>
        }
        else
        {
            <div class="settings-container">
                <div class="margin-right">
                    <label>Auto step:</label>
                    <input type="checkbox" class="margin-right" @bind="IsAuto" title="Automatically iterate through generations until the stopping condition is met."/>
                </div>
                <div class="margin-right">
                    <label>Max Iterations Without Change:</label>
                    <input type="number" @bind="MaxIterationsWithoutChange" min="@MaxIterationsWithoutChangeMin" max="@MaxIterationsWithoutChangeMax" title="The maximum number of iterations to run without any improvement in the best solution before stopping."/>
                </div>
            </div>
            <button @onclick="IterationAsync">Make iteration</button>
            <button @onclick="InitializeGenetic">Restart</button>
        }
    </div>
  
</div>

@code {
    private int PopulationSizeValue { get; set; } = 100;
    private const int PopulationSizeMin = 1;
    private const int PopulationSizeMax = 1000;

    private int PopulationSize
    {
        get => PopulationSizeValue;
        set
        {
            if (value < PopulationSizeMin || value > PopulationSizeMax || value == PopulationSizeValue) return;
            PopulationSizeValue = value;
        }
    }

    private int BestChromosomesValue { get; set; } = 50;
    private const int BestChromosomesMin = 1;
    private const int BestChromosomesMax = 100;

    private int BestChromosomes
    {
        get => BestChromosomesValue;
        set
        {
            if (value < BestChromosomesMin || value > BestChromosomesMax || value == BestChromosomesValue) return;
            BestChromosomesValue = value;
        }
    }

    private int CrossoverChromosomesValue { get; set; } = 25;
    private const int CrossoverChromosomesMin = 1;
    private const int CrossoverChromosomesMax = 100;

    private int CrossoverChromosomes
    {
        get => CrossoverChromosomesValue;
        set
        {
            if (value < CrossoverChromosomesMin || value > CrossoverChromosomesMax || value == CrossoverChromosomesValue) return;
            CrossoverChromosomesValue = value;
        }
    }

    private int MutationChromosomesValue { get; set; } = 25;
    private const int MutationChromosomesMin = 1;
    private const int MutationChromosomesMax = 100;

    private int MutationChromosomes
    {
        get => MutationChromosomesValue;
        set
        {
            if (value < MutationChromosomesMin || value > MutationChromosomesMax || value == MutationChromosomesValue) return;
            MutationChromosomesValue = value;
        }
    }

    private int NumberOfCitiesValue { get; set; } = 10;
    private const int NumberOfCitiesMin = 1;
    private const int NumberOfCitiesMax = 100;

    private int NumberOfCities
    {
        get => NumberOfCitiesValue;
        set
        {
            if (value < NumberOfCitiesMin || value > NumberOfCitiesMax || value == NumberOfCitiesValue) return;
            NumberOfCitiesValue = value;
        }
    }

    private int MaxIterationsWithoutChangeValue { get; set; } = 10000;
    private const int MaxIterationsWithoutChangeMin = 0;
    private const int MaxIterationsWithoutChangeMax = 1000000;

    private int MaxIterationsWithoutChange
    {
        get => MaxIterationsWithoutChangeValue;
        set
        {
            if (value < MaxIterationsWithoutChangeMin || value > MaxIterationsWithoutChangeMax || value == MaxIterationsWithoutChangeValue) return;
            MaxIterationsWithoutChangeValue = value;
        }
    }

    private bool IsAuto { get; set; }
    public int Iteration { get; set; }
    private BJProblemData? BJProblemData { get; set; }
    private Genetic<BJChromosome>? Genetic { get; set; }

    private void InitializeGenetic()
    {
        var geneticAlgorithmSettings = new GeneticAlgorithmSettings
        {
            Population = PopulationSize,
            BestChromosomes = BestChromosomes,
            CrossoverChromosomes = CrossoverChromosomes,
            MutationChromosomes = MutationChromosomes
        };

        var randomProvider = RandomProvider.Shared;
      
        StateHasChanged();
    }

    private async Task IterationAsync()
    {
        Iteration = 0;
        do
        {
            Genetic?.NextIteration();
            Iteration++;
            StateHasChanged();
            await Task.Yield();
            await Task.Delay(1);
        } while (IsAuto && Iteration < MaxIterationsWithoutChangeValue);
    }

}

<style>
    :root {
        --gap-size: 10px;
    }

    .page-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 56px - var(--gap-size));
    }

    .parameters-container {
        margin-bottom: var(--gap-size);
    }

    .map-component {
        flex-grow: 1;
        min-height: 100px;
        min-width: 100px;
    }

    canvas {
        border: 1px solid black;
    }
</style>